
# AGENTS.md（协作与开发规范）

本文件用于约束在本仓库进行功能开发/修复/重构时的工程规范与安全基线。**不要求向后兼容**，但必须满足安全与隐私保护要求。

---

## 1. 总原则

- **安全优先**：任何功能开发都必须进行安全检测，不能导致信息泄露。
- **最小权限**：接口、数据、存储、后台能力按最小必要授权。
- **最小暴露**：不要在响应、日志、错误、前端代码、缓存中暴露敏感信息。
- **高内聚低耦合**：UI 与核心逻辑分离；遵循 SOLID / DRY / SRP。

---

## 2. 强制流程：每次功能开发必须做安全检测（阻断规则）

以下任一项不满足，**不得合并/发布**：

1. **自检清单**：完成本文件的《安全检测清单》并逐项确认。
2. **接口回归**：对新增/修改的 API 路由进行“未登录/低权限/越权/非法输入/异常路径”回归。
3. **信息泄露审查**：确认**日志、错误信息、响应体、缓存、下载链接**不泄露敏感数据。
4. **密钥与配置审查**：确认**无密钥硬编码、无环境变量误上送到客户端**。

---

## 3. 安全检测清单（每次改动都要过）

### 3.1 访问控制（AuthN/AuthZ）

- **鉴权**：所有需要登录的 API 必须校验会话/令牌，未登录返回一致的错误响应（避免枚举）。
- **授权**：按资源维度做权限判断（避免“只判断是否登录”导致越权）。
- **对象级权限**：对 `id/email/userId` 等资源标识进行所有权校验，防止 IDOR。
- **管理员接口**：必须与普通用户路径隔离，且审计记录（见“审计与日志”）。

### 3.2 输入校验与注入防护

- **输入校验**：对 query/body/path 参数进行白名单校验与长度限制（避免超大 payload 与边界绕过）。
- **注入防护**：任何拼接 SQL/HTML/URL/文件路径的地方，必须使用参数化或安全构造方式。
- **文件上传**：校验文件类型/大小；不要信任 `Content-Type`；避免任意文件写入/覆盖。

### 3.3 信息泄露（核心）

- **响应体**：不得返回密码、验证码、令牌、session、私钥、邮箱验证码明文、第三方密钥等。
- **错误信息**：生产环境错误响应不得包含堆栈、SQL、内部路径、环境变量、上游服务细节。
- **日志**：日志不得打印：
  - `Authorization`/`Cookie`/`Set-Cookie`
  - 验证码、重置链接 token、会话 token、Turnstile token、邮箱/手机号全量（必要时脱敏）
  - 用户上传内容中的敏感片段（必要时做哈希或截断）
- **前端泄露**：不要把服务器端环境变量/密钥通过 `public-config`、页面 props、打包代码暴露给客户端。

### 3.4 Cookie / Session 安全

- **Cookie 属性**：敏感会话 Cookie 必须 `HttpOnly` + `Secure` + 合理 `SameSite`，并设置明确的 `Max-Age/Expires`。
- **会话固定**：登录/提权后旋转会话标识；登出清理 Cookie。
- **CSRF**：若使用 Cookie 作为认证，写操作需具备 CSRF 防护（SameSite 策略 + token/双提交等至少一种）。

### 3.5 缓存与下载链接（Cloudflare/边缘场景高风险）

- **禁止缓存私密数据**：用户/管理员接口需设置合适的 `Cache-Control`（通常 `no-store`）。
- **下载链接**：若使用 R2/对象存储签名 URL：
  - URL 必须短 TTL、与用户权限绑定、不可枚举
  - 不要在日志/错误里输出完整签名 URL
- **CDN/边缘缓存**：确保不会把带 Cookie 的响应错误缓存为公共内容。

### 3.6 速率限制与滥用防护

- **验证码/登录/找回密码**：必须有速率限制与失败计数（防暴力与撞库）。
- **资源型接口**：对生成/上传/下载/导出等高成本接口限流或配额。

### 3.7 前端 XSS 与内容安全

- **不信任用户内容**：任何可渲染用户输入的内容必须转义/净化；避免 `dangerouslySetInnerHTML`。
- **CSP/Headers**：新增页面或嵌入第三方脚本时，确认安全头策略不被削弱（见 `public/_headers`）。

### 3.8 数据最小化与隐私

- **最小采集**：只存业务必要字段；避免存储完整设备指纹/敏感信息。
- **脱敏展示**：管理后台/日志/审计展示敏感字段需脱敏（如邮箱、IP、token）。

---

## 4. 代码评审要点（提交前自查）

- **不要新增/扩大公共配置**：任何“公开配置接口”必须只返回真正可公开信息。
- **不要扩大错误回显**：避免把外部服务错误原样返回给客户端（尤其是包含 requestId、内部路径、栈信息的）。
- **新增 API 路由必查**：鉴权、授权、输入校验、Cache-Control、日志脱敏、速率限制。
- **新增存储必查**：R2/数据库表字段是否包含敏感信息；是否需要加密/TTL/访问控制。

---

## 5. 安全问题发现后的处理

- **立即阻断**：发现潜在泄露或越权，优先修复与回滚，禁止带风险上线。
- **最小披露**：排查过程中不要把真实密钥/令牌/用户数据贴到 PR/Issue/聊天。
- **修复后复盘**：补充测试/校验/限制，避免同类问题再次出现。

## 6. Agents 开发规范

本项目使用 AI Agents 进行半自动化开发和协作。本文档用于约束和指导后续基于 Agents 的规范化开发，确保代码质量、一致性和可维护性。

---

### 6.1 开发原则（SOLID / DRY / SRP）

- **SOLID 原则**
  - **S（单一职责）**: 每个模块/类/函数只负责一件清晰的事情。
  - **O（开闭原则）**: 对扩展开放，对修改关闭。优先通过新增模块或配置来扩展能力。
  - **L（里氏替换原则）**: 子类型必须可以替换父类型，不破坏现有逻辑。
  - **I（接口隔离）**: 拆分胖接口，避免冗余依赖。
  - **D（依赖倒置）**: 业务逻辑依赖抽象，而不是具体实现，便于替换和测试。

- **DRY 原则（Don’t Repeat Yourself）**
  - 抽取公共逻辑到工具函数、hooks、服务层，而不是在多个组件中复制粘贴。
  - 对于可复用的 UI 片段，优先封装为可组合的组件。

- **SRP 原则（Single Responsibility Principle）**
  - UI 组件只负责展示和基本交互，不直接承载复杂业务逻辑。
  - 服务层/业务模块只负责业务逻辑，不关心 UI 具体如何展示。

- **高内聚，低耦合**
  - 相关的功能代码放在同一模块或同一领域目录下。
  - 模块间通过清晰的接口通信，避免相互强引用和隐式耦合。

- **UI 与核心逻辑分离**
  - **核心逻辑**：放在 service、utils、hooks 等可测试的纯逻辑层。
  - **UI 层**：只通过 props、回调、上下文等方式使用核心逻辑提供的能力。

---

### 6.2 代码结构与分层约定

- **自解释的目录与结构**
  - 通过目录结构和文件命名即可大致看出其职责和业务含义，例如按领域/业务模块划分目录（如 `admin/`、`user/`、`profile/` 等）。
  - 避免将不相关的功能堆在同一目录或同一文件中；大文件应按职责拆分为多个更小的模块。
  - 新增代码时，优先考虑“别人只看结构和命名就能猜到用途”，减少额外口头说明的必要。

- **页面层（例如 Next.js 的 `app/*/page.tsx`）**
  - 负责路由、数据获取/预取的入口（如 `getServerSideProps` / `route handlers` / RSC 数据获取）。
  - 将数据与行为通过 props 传递给下层 UI 组件。

- **UI 组件层**
  - 组件保持可复用、可组合、无业务上下文强依赖。
  - 避免在 UI 组件内部直接写复杂业务逻辑或访问全局单例。

- **业务逻辑层（services / domain / use-cases）**
  - 封装具体业务操作（如“创建用户”、“更新个人资料”、“执行某个管理操作”）。
  - 提供清晰的函数接口给页面/组件调用。

- **工具层（utils / helpers）**
  - 封装与具体业务无关的通用函数（格式化、校验、转换等）。

---

### 6.3 Agents 使用与协作规范

- **任务理解与规划**
  - 在修改代码前，Agent 应先：
    - 明确需求目标与范围。
    - 判断是否需要拆分为多个子任务。
    - 评估是否需要编写/更新文档、测试用例。

- **代码编辑策略**
  - 优先在现有结构和约定内扩展，不随意引入新的架构风格。
  - 避免一次提交中同时引入大量不相关的重构；若需重构，应与功能开发拆分。
  - 严格遵守项目现有的代码风格、命名约定与目录结构。

- **测试与验证**
  - 对有明显逻辑分支的变更，应至少覆盖：
    - 正常路径（happy path）。
    - 主要异常/边界情况（如参数为空、权限不足、数据不存在等）。
  - UI 变更需：
    - 在对应页面进行手动验证或给出可验证步骤。
    - 注意响应式布局和常见浏览器兼容性（如有前端 UI）。

- **文档与可读性**
  - 对重要的业务流程或非直观实现，必须撰写注释或更新相关文档。
  - 所有新的公共 API、hooks、服务函数，应在相应模块或 README 中简单说明用途和入参/出参。

---

### 6.4 变更规范（适用于 Agents 与人工协作）

- **小步提交**
  - 将大改动拆解为小的、可审查的变更单元。
  - 每个变更尽量只关注一个问题（例如：修复 bug / 增加接口 / 调整 UI）。

- **破坏性变更（允许）**
  - 本仓库**不要求向后兼容**；如修改公共接口（函数签名、API 返回结构）会影响现有调用方，必须在文档中明确说明**影响范围与迁移方式**。

- **错误处理与日志**
  - 在服务层或接口层对异常进行统一处理，避免将底层错误直接暴露给 UI。
  - 对关键路径（例如权限校验、重要数据变更）适当添加日志或埋点（如果项目中已有相关机制）。

---

### 6.5 与外部库、API 的交互

- **抽象外部依赖**
  - 使用适配层/封装函数来隔离第三方库和外部 API，避免在业务逻辑中直接使用第三方细节。
  - 便于将来替换库或调整实现（符合依赖倒置与开闭原则）。

- **配置与密钥**
  - 环境相关配置（API 地址、密钥等）统一使用配置文件或环境变量管理，不应写死在代码中。
  - Agents 在改动涉及配置时，应在文档中说明新增/修改的配置项。

---

### 6.6 性能与安全

- **性能**
  - 避免不必要的重复计算和重复请求，适当使用缓存或 memoization（视项目技术栈而定）。
  - UI 层注意减少不必要的重渲染，拆分组件、使用合适的状态管理方案。

- **安全**
  - 对输入数据进行校验和清洗，避免 SQL 注入、XSS 等常见问题。
  - 严格区分客户端/服务端可用数据，敏感数据只在服务端处理，不在前端持久化。

#### 6.6.1 客户端体验（强制）：Cache-First + 登录后预加载（无损优化）

目标：**不改样式、不改现有功能逻辑结果**，但避免“切换页面就触发 Loading + 请求”的体验问题。

- **新增聚合预加载接口（Bootstrap API）**
  - 只新增，不改现有接口。
  - 必须基于 **httpOnly session cookie** 鉴权（避免通过 `email/userId` 参数导致越权/IDOR）。
  - 必须设置 `Cache-Control: no-store`，避免用户数据被边缘缓存。
  - 示例：`GET /api/user/dashboard-bootstrap`（当前实现已落地）。

- **登录成功后预加载并写入一次性缓存**
  - 登录成功后立刻请求 Bootstrap API。
  - 预加载数据仅允许写入 **sessionStorage（一次性）**，用于跨整页跳转/刷新恢复。
  - 登出时必须清理缓存（项目里 `UserContext.clearUser()` 会清空 `sessionStorage`）。

- **页面/Hook 数据获取必须 Cache-First**
  - 页面渲染时先检查缓存（例如 `useApiCache().get(fetchUrl)`）。
  - **缓存命中：直接展示，不显示 Loading，不再发请求。**
  - **缓存缺失：走原逻辑（发请求 + Loading）**，保证直达 URL/刷新时行为不变。

- **有写操作时同步更新/失效缓存**
  - 例如上传/删除订单、增删设备：必须同步更新或清理对应缓存 Key，避免“操作成功但切页又看到旧数据”。
  - 优先更新同一 URL Key 的缓存值（保持页面逻辑不变）。

---

### 6.7 文档维护与约定更新

- **持续更新**
  - 当引入新的架构模式、规范或工具链时，应同步更新本 `agents.md` 或相关文档。
  - 若发现现有约定无法很好支持新需求，应先在文档层面达成新的共识，再由 Agents/人工共同遵循。

- **变更记录**
  - 对于重要规范调整，可在仓库其他位置（如 `CHANGELOG`、`CONTRIBUTING` 或单独章节）记录变更原因与影响范围。

---

### 6.8 最佳实践总结

- **优先考虑可维护性而非一次性最短实现路径。**
- **保持模块职责清晰、接口简洁明确。**
- **减少重复代码，善用抽象与封装。**
- **让 UI 更专注于“展示和交互”，让核心逻辑更专注于“业务与规则”。**
## 7. UI样式设计原则
- 根据https://ant.design/components/notification-cn 查找合适的ui组件，设计系统样式，确保样式现代美观,同时确保响应式布局和跨浏览器兼容性
Agents 与人工开发者在本项目中应共同遵循以上规范，以保证整个代码库在长期演进过程中的一致性与可维护性。


